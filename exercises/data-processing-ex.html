<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; }
code > span.dt { color: #204a87; }
code > span.dv { color: #0000cf; }
code > span.bn { color: #0000cf; }
code > span.fl { color: #0000cf; }
code > span.ch { color: #4e9a06; }
code > span.st { color: #4e9a06; }
code > span.co { color: #8f5902; font-style: italic; }
code > span.ot { color: #8f5902; }
code > span.al { color: #ef2929; }
code > span.fu { color: #000000; }
code > span.er { font-weight: bold; }
  </style>
  <link href="data:text/css,%2F%2A%20%0A%20This%20document%20has%20been%20created%20with%20Marked%2Eapp%20%3Chttp%3A%2F%2Fmarkedapp%2Ecom%3E%2C%20Copyright%202011%20Brett%20Terpstra%0A%20Please%20leave%20this%20notice%20in%20place%2C%20along%20with%20any%20additional%20credits%20below%2E%0A%20%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%2D%0A%20SwissStyle%20by%20Brett%20Terpstra%0A%20%2A%2F%0A%0Abody%0A%7B%0A%20%20%20%20%2Dwebkit%2Dfont%2Dsmoothing%3Aantialiased%3B%0A%20%20%20%20font%3Anormal%20%2E8764em%2F1%2E5em%20Arial%2CVerdana%2Csans%2Dserif%3B%0A%20%20%20%20margin%3A10px%20150px%3B%0A%20%20%20%20border%2Dstyle%3Adotted%3B%0A%20%20%20%20border%2Dwidth%3A1pt%3B%0A%20%20%20%20padding%3A40pt%3B%0A%7D%0A%0Ahtml%3Ebody%0A%7B%0A%20%20%20%20font%2Dsize%3A13px%0A%7D%0A%0Ali%0A%7B%0A%20%20%20%20font%2Dsize%3A110%25%0A%7D%0A%0Ali%20li%0A%7B%0A%20%20%20%20font%2Dsize%3A100%25%0A%7D%0A%0Ali%20p%0A%7B%0A%20%20%20%20font%2Dsize%3A100%25%3B%0A%20%20%20%20margin%3A%2E5em%200%0A%7D%0A%0Ah1%0A%7B%0A%20%20%20%20color%3A%23002b36%3B%0A%20%20%20%20font%2Dsize%3A2%2E2857em%3B%0A%20%20%20%20line%2Dheight%3A%2E6563em%3B%0A%20%20%20%20margin%3A%2E6563em%200%0A%7D%0A%0Ah2%0A%7B%0A%20%20%20%20color%3A%23111%3B%0A%20%20%20%20font%2Dsize%3A1%2E7143em%3B%0A%20%20%20%20line%2Dheight%3A%2E875em%3B%0A%20%20%20%20margin%3A%2E875em%200%0A%7D%0A%0Ah3%0A%7B%0A%20%20%20%20color%3A%23111%3B%0A%20%20%20%20font%2Dsize%3A1%2E5em%3B%0A%20%20%20%20line%2Dheight%3A1em%3B%0A%20%20%20%20margin%3A1em%200%0A%7D%0A%0Ah4%0A%7B%0A%20%20%20%20color%3A%23111%3B%0A%20%20%20%20font%2Dsize%3A1%2E2857em%3B%0A%20%20%20%20line%2Dheight%3A1%2E1667em%3B%0A%20%20%20%20margin%3A1%2E1667em%200%0A%7D%0A%0Ah5%0A%7B%0A%20%20%20%20color%3A%23111%3B%0A%20%20%20%20font%2Dsize%3A1%2E15em%3B%0A%20%20%20%20line%2Dheight%3A1%2E3em%3B%0A%20%20%20%20margin%3A1%2E3em%200%0A%7D%0A%0Ah6%0A%7B%0A%20%20%20%20font%2Dsize%3A1em%3B%0A%20%20%20%20line%2Dheight%3A1%2E5em%3B%0A%20%20%20%20margin%3A1%2E5em%200%0A%7D%0A%0Abody%2Cp%2Ctd%2Cdiv%0A%7B%0A%20%20%20%20color%3A%23111%3B%0A%20%20%20%20font%2Dfamily%3A%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20Verdana%2C%20sans%2Dserif%3B%0A%20%20%20%20word%2Dwrap%3Abreak%2Dword%0A%7D%0A%0Ah1%2Ch2%2Ch3%2Ch4%2Ch5%2Ch6%0A%7B%0A%20%20%20%20line%2Dheight%3A1%2E5em%0A%7D%0A%0Aa%0A%7B%0A%20%20%20%20%2Dwebkit%2Dtransition%3Acolor%20%2E2s%20ease%2Din%2Dout%3B%0A%20%20%20%20color%3A%230d6ea1%3B%0A%20%20%20%20text%2Ddecoration%3Anone%0A%7D%0A%0Aa%3Ahover%0A%7B%0A%20%20%20%20color%3A%233593d9%0A%7D%0A%0A%2F%2Ah2%20em%0A%7B%0A%20%20%20%20color%3A%23111%3B%0A%20%20%20%20padding%2Dleft%3A10px%3B%0A%20%20%20%20text%2Dshadow%3A0%201px%200%20%23FFF%0A%7D%2A%2F%0A%0A%2Efootnote%0A%7B%0A%20%20%20%20color%3A%230d6ea1%3B%0A%20%20%20%20font%2Dsize%3A%2E8em%3B%0A%20%20%20%20vertical%2Dalign%3Asuper%0A%7D%0A%0A%23wrapper%20img%0A%7B%0A%20%20%20%20max%2Dwidth%3A80%25%3B%0A%20%20%20%20width%3A400%3B%0A%7D%0A%0Add%0A%7B%0A%20%20%20%20margin%2Dbottom%3A1em%0A%7D%0A%0Ali%20%3E%20p%3Afirst%2Dchild%0A%7B%0A%20%20%20%20margin%3A0%0A%7D%0A%0Aul%20ul%2Cul%20ol%0A%7B%0A%20%20%20%20margin%2Dbottom%3A%2E4em%0A%7D%0A%0Acaption%2Ccol%2Ccolgroup%2Ctable%2Ctbody%2Ctd%2Ctfoot%2Cth%2Cthead%2Ctr%0A%7B%0A%20%20%20%20border%2Dspacing%3A0%0A%7D%0A%0Atable%0A%7B%0A%20%20%20%20border%3A1px%20solid%20rgba%280%2C0%2C0%2C0%2E25%29%3B%0A%20%20%20%20border%2Dcollapse%3Acollapse%3B%0A%20%20%20%20display%3Atable%3B%0A%20%20%20%20empty%2Dcells%3Ahide%3B%0A%20%20%20%20margin%3A%2D1px%200%2023px%3B%0A%20%20%20%20padding%3A0%3B%0A%20%20%20%20table%2Dlayout%3Afixed%0A%7D%0A%0Acaption%0A%7B%0A%20%20%20%20display%3Atable%2Dcaption%3B%0A%20%20%20%20font%2Dweight%3A700%0A%7D%0A%0Acol%0A%7B%0A%20%20%20%20display%3Atable%2Dcolumn%0A%7D%0A%0Acolgroup%0A%7B%0A%20%20%20%20display%3Atable%2Dcolumn%2Dgroup%0A%7D%0A%0Atbody%0A%7B%0A%20%20%20%20display%3Atable%2Drow%2Dgroup%0A%7D%0A%0Atfoot%0A%7B%0A%20%20%20%20display%3Atable%2Dfooter%2Dgroup%0A%7D%0A%0Athead%0A%7B%0A%20%20%20%20display%3Atable%2Dheader%2Dgroup%0A%7D%0A%0Atd%2Cth%0A%7B%0A%20%20%20%20display%3Atable%2Dcell%0A%7D%0A%0Atr%0A%7B%0A%20%20%20%20display%3Atable%2Drow%0A%7D%0A%0Atable%20th%2Ctable%20td%0A%7B%0A%20%20%20%20font%2Dsize%3A1%2E1em%3B%0A%20%20%20%20line%2Dheight%3A23px%3B%0A%20%20%20%20padding%3A0%201em%0A%7D%0A%0Atable%20thead%0A%7B%0A%20%20%20%20background%3Argba%280%2C0%2C0%2C0%2E15%29%3B%0A%20%20%20%20border%3A1px%20solid%20rgba%280%2C0%2C0%2C0%2E15%29%3B%0A%20%20%20%20border%2Dbottom%3A1px%20solid%20rgba%280%2C0%2C0%2C0%2E2%29%0A%7D%0A%0Atable%20tbody%0A%7B%0A%20%20%20%20background%3Argba%280%2C0%2C0%2C0%2E05%29%0A%7D%0A%0Atable%20tfoot%0A%7B%0A%20%20%20%20background%3Argba%280%2C0%2C0%2C0%2E15%29%3B%0A%20%20%20%20border%3A1px%20solid%20rgba%280%2C0%2C0%2C0%2E15%29%3B%0A%20%20%20%20border%2Dtop%3A1px%20solid%20rgba%280%2C0%2C0%2C0%2E2%29%0A%7D%0A%0Afigure%0A%7B%0A%20%20%20%20display%3Ainline%2Dblock%3B%0A%20%20%20%20margin%2Dbottom%3A1%2E2em%3B%0A%20%20%20%20position%3Arelative%0A%7D%0A%0Afigcaption%0A%7B%0A%20%20%20%20%2Dwebkit%2Dtransition%3Aall%20%2E2s%20ease%2Din%2Dout%3B%0A%20%20%20%20background%3Argba%280%2C0%2C0%2C0%29%3B%0A%20%20%20%20bottom%3A0%3B%0A%20%20%20%20color%3Argba%28255%2C255%2C255%2C0%29%3B%0A%20%20%20%20left%3A0%3B%0A%20%20%20%20position%3Aabsolute%3B%0A%20%20%20%20text%2Dalign%3Acenter%3B%0A%20%20%20%20width%3A100%25%0A%7D%0A%0Afigure%3Ahover%0A%7B%0A%20%20%20%20cursor%3Apointer%0A%7D%0A%0Afigcaption%3Ahover%0A%7B%0A%20%20%20%20background%3Argba%280%2C0%2C0%2C%2E56%29%3B%0A%20%20%20%20color%3Argba%28255%2C255%2C255%2C1%29%0A%7D%0A%0A%0A%2Equote%20pre%0A%7B%0A%20%20%20%20display%3Ablock%3B%0A%20%20%20%20font%2Dfamily%3AGeorgia%2C%20Garamond%2C%20serif%21important%3B%0A%20%20%20%20font%2Dsize%3A110%25%21important%3B%0A%20%20%20%20font%2Dstyle%3Aitalic%3B%0A%20%20%20%20line%2Dheight%3A1%2E6em%3B%0A%20%20%20%20margin%2Dleft%3A1em%0A%7D%0A%0A%2Equote%20pre%20code%0A%7B%0A%20%20%20%20display%3Ablock%3B%0A%20%20%20%20font%2Dfamily%3AGeorgia%2C%20Garamond%2C%20serif%21important%3B%0A%20%20%20%20margin%2Dleft%3A%2E5em%3B%0A%20%20%20%20background%3Argba%280%2C0%2C0%2C%2E1%29%3B%0A%7D%0A%0Apre%20code%20%7B%0A%20%20display%3A%20block%3B%20padding%3A%200%2E5em%3B%0A%20%20background%3A%20%23fdf6e3%3B%20color%3A%20%23657b83%3B%0A%7D%0A%0Apre%20%2Ecomment%2C%0Apre%20%2Etemplate%5Fcomment%2C%0Apre%20%2Ediff%20%2Eheader%2C%0Apre%20%2Edoctype%2C%0Apre%20%2Elisp%20%2Estring%2C%0Apre%20%2Ejavadoc%20%7B%0A%20%20color%3A%20%2393a1a1%3B%0A%20%20font%2Dstyle%3A%20italic%3B%0A%7D%0A%0Apre%20%2Ekeyword%2C%0Apre%20%2Ecss%20%2Erule%20%2Ekeyword%2C%0Apre%20%2Ewinutils%2C%0Apre%20%2Ejavascript%20%2Etitle%2C%0Apre%20%2Emethod%2C%0Apre%20%2Eaddition%2C%0Apre%20%2Ecss%20%2Etag%2C%0Apre%20%2Elisp%20%2Etitle%20%7B%0A%20%20color%3A%20%23859900%3B%0A%7D%0A%0Apre%20%2Enumber%2C%0Apre%20%2Ecommand%2C%0Apre%20%2Estring%2C%0Apre%20%2Etag%20%2Evalue%2C%0Apre%20%2Ephpdoc%2C%0Apre%20%2Etex%20%2Eformula%2C%0Apre%20%2Eregexp%2C%0Apre%20%2Ehexcolor%20%7B%0A%20%20color%3A%20%232aa198%3B%0A%7D%0A%0Apre%20%2Etitle%2C%0Apre%20%2Elocalvars%2C%0Apre%20%2Efunction%20%2Etitle%2C%0Apre%20%2Echunk%2C%0Apre%20%2Edecorator%2C%0Apre%20%2Ebuiltin%2C%0Apre%20%2Ebuilt%5Fin%2C%0Apre%20%2Elisp%20%2Etitle%2C%0Apre%20%2Eidentifier%2C%0Apre%20%2Etitle%20%2Ekeymethods%2C%0Apre%20%2Eid%20%7B%0A%20%20color%3A%20%23268bd2%3B%0A%7D%0A%0Apre%20%2Etag%20%2Etitle%2C%0Apre%20%2Erules%20%2Eproperty%2C%0Apre%20%2Edjango%20%2Etag%20%2Ekeyword%20%7B%0A%20%20font%2Dweight%3A%20bold%3B%0A%7D%0A%0Apre%20%2Eattribute%2C%0Apre%20%2Evariable%2C%0Apre%20%2Einstancevar%2C%0Apre%20%2Elisp%20%2Ebody%2C%0Apre%20%2Esmalltalk%20%2Enumber%2C%0Apre%20%2Econstant%2C%0Apre%20%2Eclass%20%2Etitle%2C%0Apre%20%2Eparent%2C%0Apre%20%2Ehaskell%20%2Elabel%20%7B%0A%20%20color%3A%20%23b58900%3B%0A%7D%0A%0Apre%20%2Epreprocessor%2C%0Apre%20%2Epi%2C%0Apre%20%2Eshebang%2C%0Apre%20%2Esymbol%2C%0Apre%20%2Ediff%20%2Echange%2C%0Apre%20%2Especial%2C%0Apre%20%2Ekeymethods%2C%0Apre%20%2Eattr%5Fselector%2C%0Apre%20%2Eimportant%2C%0Apre%20%2Esubst%2C%0Apre%20%2Ecdata%20%7B%0A%20%20color%3A%20%23cb4b16%3B%0A%7D%0A%0Apre%20%2Edeletion%20%7B%0A%20%20color%3A%20%23dc322f%3B%0A%7D%0A%0Apre%20%2Etex%20%2Eformula%20%7B%0A%20%20background%3A%20%23eee8d5%3B%0A%7D%0A%0A%0Asup%2Csub%2Ca%2Efootnote%0A%7B%0A%20%20%20%20font%2Dsize%3A1%2E4ex%3B%0A%20%20%20%20height%3A0%3B%0A%20%20%20%20line%2Dheight%3A1%3B%0A%20%20%20%20position%3Arelative%3B%0A%20%20%20%20vertical%2Dalign%3Asuper%0A%7D%0A%0Asub%20%7B%0A%20%20%20%20vertical%2Dalign%3A%20sub%3B%0A%20%20%20%20top%3A%20%2D1px%3B%0A%7D%0A%0Ap%2Ch5%0A%7B%0A%20%20%20%20font%2Dsize%3A1%2E1429em%3B%0A%20%20%20%20line%2Dheight%3A1%2E3125em%3B%0A%20%20%20%20margin%3A1%2E3125em%200%0A%7D%0A%0Adt%2Cth%0A%7B%0A%20%20%20%20font%2Dweight%3A700%0A%7D%0A%0Atable%20tr%3Anth%2Dchild%28odd%29%2Ctable%20th%3Anth%2Dchild%28odd%29%2Ctable%20td%3Anth%2Dchild%28odd%29%0A%7B%0A%20%20%20%20background%3Argba%28255%2C255%2C255%2C0%2E06%29%0A%7D%0A%0Atable%20tr%3Anth%2Dchild%28even%29%2Ctable%20td%3Anth%2Dchild%28even%29%0A%7B%0A%20%20%20%20background%3Argba%280%2C0%2C0%2C0%2E06%29%0A%7D%0A%0A%40media%20print%20%7B%0A%20%20%20%20body%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20overflow%3Aauto%0A%20%20%20%20%7D%0A%20%20%20img%2C%20pre%2C%20blockquote%2C%20table%2C%20figure%20%7B%0A%20%20%20%20%20%20%20%20page%2Dbreak%2Dinside%3A%20avoid%0A%20%20%20%20%7D%0A%20%20%20%20%2Efootnotes%20%7B%20page%2Dbreak%2Dbefore%3A%20always%20%7D%0A%0A%20%20%20%20%23wrapper%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20background%3A%23fff%3B%0A%20%20%20%20%20%20%20%20color%3A%23303030%3B%0A%20%20%20%20%20%20%20%20font%2Dsize%3A85%25%3B%0A%20%20%20%20%20%20%20%20padding%3A10px%3B%0A%20%20%20%20%20%20%20%20position%3Arelative%3B%0A%20%20%20%20%20%20%20%20text%2Dindent%3A0%0A%20%20%20%20%7D%0A%7D%0A%0A%40media%20screen%20%7B%0A%20%20%20%20%3A%3Aselection%20%7B%20background%3Argba%28157%2C%20193%2C%20200%2C%2E5%29%7D%0A%20%20%20%20%2Einverted%20%7B%0A%20%20%20%20%20%20%20%20background%3A%23333%0A%20%20%20%20%7D%0A%20%20%20%20%2Einverted%20hr%20%7B%0A%20%20%20%20%20%20%20%20border%2Dcolor%3A%20%23555%20%21important%3B%0A%20%20%20%20%7D%0A%20%20%20%20%2Einverted%20p%2C%2Einverted%20td%2C%2Einverted%20li%2C%2Einverted%20h1%2C%2Einverted%20h2%2C%2Einverted%20h3%2C%2Einverted%20h4%2C%2Einverted%20h5%2C%2Einverted%20h6%2C%2Einverted%20pre%2C%2Einverted%20code%2C%2Einverted%20th%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20color%3A%23eee%21important%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2Einverted%20a%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20color%3A%23fff%3B%0A%20%20%20%20%20%20%20%20text%2Ddecoration%3Aunderline%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%23wrapper%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20padding%3A20px%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2Einverted%20%23wrapper%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20background%3A%23333%3B%0A%20%20%20%20%7D%0A%7D%0A" rel="stylesheet">
</head>
<body>
<h1 id="data-processing-exercises">Data Processing Exercises</h1>
<h2 id="word-count-and-beyond">1. Word count and beyond</h2>
<h3 id="word-count-using-hadoop-streaming">1.1 Word count using Hadoop Streaming</h3>
<p>Implement the Python <code>mapper</code> and <code>reducer</code> scripts on the slides of week 6. Run the Hadoop streaming API on the Amazon server. Use the data in 'AMM_det_H.csv' from the drugs dataset for this.</p>
<p>Mapper:</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="co">#!/usr/bin/env python</span>

<span class="co"># Simple mapper, just like on the lecture slides</span>
<span class="co"># Lines are split on spaces:</span>
<span class="co">#  - good for word count</span>
<span class="co">#  - not good for CSV or TSV files</span>


<span class="ch">import</span> sys

<span class="kw">for</span> line in sys.stdin:
    line = line.strip()
    words = line.split()
    <span class="kw">for</span> word in words:
        <span class="dt">print</span> <span class="st">'</span><span class="ot">%s</span><span class="ch">\t</span><span class="ot">%s</span><span class="st">'</span> % (word, <span class="dv">1</span>)</code></pre>
<p>Reducer:</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="co">#!/usr/bin/env python</span>

<span class="co"># A simple reducer, as used in the lecture</span>
<span class="co"># This reducer can be used for:</span>
<span class="co"># - mapper.py: simple word count</span>
<span class="co"># - mapper1.py: all columns are passed</span>
<span class="co"># - mapper2.py: only active substances are passed</span>

<span class="ch">from</span> operator <span class="ch">import</span> itemgetter
<span class="ch">import</span> sys

current_word = <span class="ot">None</span>
current_count = <span class="dv">0</span>
word = <span class="ot">None</span>

<span class="kw">for</span> line in sys.stdin:
    line = line.strip()
    word, count = line.split(<span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, <span class="dv">1</span>)

    <span class="kw">try</span>:
        count = <span class="dt">int</span>(count)
    <span class="kw">except</span> <span class="ot">ValueError</span>:
        <span class="kw">continue</span>

    <span class="co"># this IF-switch only works because Hadoop sorts map output</span>
    <span class="co"># by key (here: word) before it is passed to the reducer</span>
    <span class="kw">if</span> current_word == word:
        current_count += count
    <span class="kw">else</span>:
        <span class="kw">if</span> current_word:
            <span class="co"># write result to STDOUT</span>
            <span class="dt">print</span> <span class="st">'</span><span class="ot">%s</span><span class="ch">\t</span><span class="ot">%s</span><span class="st">'</span> % (current_word, current_count)
        current_count = count
        current_word = word

<span class="co"># do not forget to output the last word if needed!</span>
<span class="kw">if</span> current_word == word:
    <span class="dt">print</span> <span class="st">'</span><span class="ot">%s</span><span class="ch">\t</span><span class="ot">%s</span><span class="st">'</span> % (current_word, current_count)</code></pre>
<p>Make sure the scripts can be executed (<code>chmod u+x *.py</code> if needed).</p>
<p>To run this example in the shell (not Hadoop!)</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cat</span> /mnt/bioinformatics_leuven/i0u19a/data/drugdb/AMM_det_H.csv <span class="kw">|</span> <span class="kw">./mapper.py</span> <span class="kw">|</span> <span class="kw">sort</span> -k 1,1 <span class="kw">|</span> <span class="kw">./reducer.py</span></code></pre>
<p>We first have to set some environment variables in order for the rest to work properly:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">export</span> <span class="ot">PATH=</span><span class="st">&quot;</span><span class="ot">$PATH</span><span class="st">:/mnt/bioinformatics_leuven/homes/tverbeiren/hadoop-common/hadoop-dist/target/hadoop-2.4.0/bin&quot;</span>
<span class="kw">export</span> <span class="ot">JAVA_HOME=</span><span class="st">&quot;/usr/lib/jvm/java-7-openjdk-amd64/&quot;</span>
<span class="kw">export</span> <span class="ot">PATH=</span><span class="st">&quot;</span><span class="ot">$PATH</span><span class="st">:/opt/hadoop/hadoop-dist/target/hadoop-2.4.0/bin&quot;</span>
<span class="kw">export</span> <span class="ot">PATH=</span><span class="st">&quot;</span><span class="ot">$PATH</span><span class="st">:/opt/spark/bin&quot;</span>
<span class="kw">export</span> <span class="ot">SPARK_HOME=</span><span class="st">&quot;/opt/spark&quot;</span></code></pre>
<p>To run the example using Hadoop, use the following:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">hadoop</span> jar /opt/hadoop/hadoop-tools/hadoop-streaming/target/hadoop-streaming-2.4.0.jar \
  <span class="kw">-mapper</span> mapper.py \
  <span class="kw">-reducer</span> reducer.py \
  <span class="kw">-input</span> /mnt/bioinformatics_leuven/i0u19a/data/drugdb/AMM_det_H.csv \
  <span class="kw">-output</span> output</code></pre>
<p>Does this work? Does it give some insight? Why (not)?</p>
<h3 id="attempt-2">1.2 Attempt 2</h3>
<p>What about splitting the lines (in the mapper) on ',' instead of spaces? Adapt the <code>mapper.py</code> script. Name it <code>mapper1.py</code>. Do we have to change the reducer script?</p>
<p>Mapper:</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="co">#!/usr/bin/env python</span>

<span class="co"># Lines are split on ',':</span>
<span class="co">#  - good for CSV files</span>
<span class="co"># 'All' columns are passed to reduce phase</span>


<span class="ch">import</span> sys

<span class="kw">for</span> line in sys.stdin:
    line = line.strip()
    words = line.split(<span class="st">&quot;,&quot;</span>)
    <span class="kw">for</span> word in words:
        <span class="dt">print</span> <span class="st">'</span><span class="ot">%s</span><span class="ch">\t</span><span class="ot">%s</span><span class="st">'</span> % (word, <span class="dv">1</span>)</code></pre>
<p>The reducer is the same.</p>
<p>Hadoop can be initiated like this:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">hadoop</span> jar /opt/hadoop/hadoop-tools/hadoop-streaming/target/hadoop-streaming-2.4.0.jar \
  <span class="kw">-mapper</span> mapper1.py \
  <span class="kw">-reducer</span> reducer.py \
  <span class="kw">-input</span> /mnt/bioinformatics_leuven/i0u19a/data/drugdb/AMM_det_H.csv \
  <span class="kw">-output</span> output</code></pre>
<p>Does this work? Does it give some insight? Why (not)? How many times is PARACETAMOL the active substance?</p>
<p>In order to find Paracetamol: Look in the dataset (using for instance <code>less</code>) and find the word. The answer is 136.</p>
<p>What is the most used substance?</p>
<p>Please note that in order to effectively sort in a tab-delimited dataset, you need to the following:</p>
<pre><code>cat  part-00000  | sort -r -g -k2,2 -t$'\t' | head</code></pre>
<p>Otherwise, spaces are used as delimiters.</p>
<h3 id="finding-out-about-active-substances-directly">1.3 Finding out about active substances directly</h3>
<p>We go one step further. In the previous exercise, we did a word count on all columns in the original data. We now select one specific <em>column</em>.</p>
<p>Rewrite the mapper script to only send active substance names to the reducer. Call the resulting mapper script <code>mapper2.py</code>.</p>
<p>Mapper:</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="co">#!/usr/bin/env python</span>

<span class="co"># Lines are split on ',':</span>
<span class="co">#  - good for CSV files</span>
<span class="co"># Only 3d column is passed to reduce phase</span>
<span class="co">#  - good for drugdb (AMM_det_H, active subst. column)</span>


<span class="ch">import</span> sys

<span class="kw">for</span> line in sys.stdin:
    words = line.strip().split(<span class="st">&quot;,&quot;</span>)
    <span class="dt">print</span> <span class="st">'</span><span class="ot">%s</span><span class="ch">\t</span><span class="ot">%s</span><span class="st">'</span> % (words[<span class="dv">2</span>], <span class="dv">1</span>)</code></pre>
<p>The reducer remains the same.</p>
<p>To run Hadoop:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">hadoop</span> jar /opt/hadoop/hadoop-tools/hadoop-streaming/target/hadoop-streaming-2.4.0.jar \
  <span class="kw">-mapper</span> mapper2.py \
  <span class="kw">-reducer</span> reducer.py \
  <span class="kw">-input</span> /mnt/bioinformatics_leuven/i0u19a/data/drugdb/AMM_det_H.csv \
  <span class="kw">-output</span> output</code></pre>
<p>The most active substance? This is the top-10:</p>
<pre><code>cat  part-00000  | sort -r -g -k2,2 -t$'\t' | head</code></pre>
<h3 id="active-substances-and-maximum-doses">1.4 Active substances and maximum doses</h3>
<p>Rewrite <code>mapper</code> and <code>reducer</code> such that not only do we count how many occurrences there are of a certain active substance, but also report the maximum dose.</p>
<p><em>Important</em>: do this is 1 run.</p>
<p>Name the scripts <code>mapper3.py</code> and <code>reducer3.py</code>. Think of the assignments you did in preparation of this week's exercises.</p>
<p>Mapper:</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="co">#!/usr/bin/env python</span>

<span class="co"># Mapper for AMM_det_H.csv</span>
<span class="co"># Lines are split on ',':</span>
<span class="co">#  - good for CSV files</span>
<span class="co"># 2 columns are passed to reducer:</span>
<span class="co">#  - 3d column: Active Substance</span>
<span class="co">#  - 5th column: Dose, double quotes are removed</span>
<span class="co"># We pass 2 values (aka a list) to the reducer.</span>
<span class="co"># Please note that key and value(s) are separated by '\t'</span>

<span class="ch">import</span> sys

<span class="kw">for</span> line in sys.stdin:
    words = line.strip().split(<span class="st">&quot;,&quot;</span>)
    <span class="dt">print</span> <span class="st">'</span><span class="ot">%s</span><span class="ch">\t</span><span class="ot">%s</span><span class="st">,</span><span class="ot">%s</span><span class="st">'</span> % (words[<span class="dv">2</span>], <span class="dv">1</span>, words[<span class="dv">4</span>].replace(<span class="st">'&quot;'</span>, <span class="st">''</span>))</code></pre>
<p>Reducer:</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="co">#!/usr/bin/env python</span>

<span class="co"># A simple reducer, as used in the lecture</span>
<span class="co"># This reducer can be used for:</span>
<span class="co">#   - mapper3.py</span>
<span class="co"># The two values are extracted and the maximum value</span>
<span class="co"># of the dose is passed as an additional column in the output.</span>


<span class="ch">import</span> sys

current_word = <span class="ot">None</span>
current_count = <span class="dv">0</span>
max_dose = <span class="dv">0</span>
word = <span class="ot">None</span>

<span class="kw">for</span> line in sys.stdin:
    line = line.strip()
    word, rest = line.split(<span class="st">'</span><span class="ch">\t</span><span class="st">'</span>)
    count, dose = rest.split(<span class="st">','</span>)

    <span class="kw">try</span>:
        count = <span class="dt">int</span>(count)
    <span class="kw">except</span> <span class="ot">ValueError</span>:
        <span class="kw">continue</span>
    <span class="kw">try</span>:
        dose = <span class="dt">float</span>(dose)
    <span class="kw">except</span> <span class="ot">ValueError</span>:
        <span class="kw">continue</span>

    <span class="co"># this IF-switch only works because Hadoop sorts map output</span>
    <span class="co"># by key (here: word) before it is passed to the reducer</span>
    <span class="kw">if</span> current_word == word:
        current_count += count
        <span class="kw">if</span> max_dose &lt; dose:
            max_dose = dose
    <span class="kw">else</span>:
        <span class="kw">if</span> current_word:
            <span class="co"># write result to STDOUT</span>
            <span class="dt">print</span> <span class="st">'</span><span class="ot">%s</span><span class="ch">\t</span><span class="ot">%s</span><span class="ch">\t</span><span class="ot">%s</span><span class="st">'</span> % (current_word, current_count, dose)
        current_count = count
        current_word = word
        max_dose = dose

<span class="co"># do not forget to output the last word if needed!</span>
<span class="kw">if</span> current_word == word:
    <span class="dt">print</span> <span class="st">'</span><span class="ot">%s</span><span class="ch">\t</span><span class="ot">%s</span><span class="ch">\t</span><span class="ot">%s</span><span class="st">'</span> % (current_word, current_count,dose)</code></pre>
<p>Hadoop run:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">hadoop</span> jar /opt/hadoop/hadoop-tools/hadoop-streaming/target/hadoop-streaming-2.4.0.jar \
  <span class="kw">-mapper</span> mapper3.py \
  <span class="kw">-reducer</span> reducer3.py \
  <span class="kw">-input</span> /mnt/bioinformatics_leuven/i0u19a/data/drugdb/AMM_det_H.csv \
  <span class="kw">-output</span> output</code></pre>
<p>Is this a convenient way to work? What would make your life easier?</p>
<p>This is a poor way to pass additional data between two phases. We could use different approaches: <code>JSON</code>, ... Another option would be to use a datamodel and work with objects. These objects then need to be converted to a stream of data.</p>
<h2 id="normalization">2. Normalization</h2>
<h3 id="joins">2.1 Joins</h3>
<p>Refer to the exercises on RDBMs, and look up what kind of questions we posed.</p>
<p>One of them was: <em>Which companies have compounds on the market with more than 10 active substances?</em></p>
<p>Think of how you would approach that?</p>
<h3 id="normalization-or-not">2.2 Normalization or not?</h3>
<p>What is your opinion on normalization? Is it a good thing?</p>
<h3 id="reduce-side-join">2.3 Reduce-side Join</h3>
<p>Rewrite the map and reduce phase such that we can get the answer to the question above. Call the scripts <code>mapperJoin.py</code> and <code>reducerJoin.py</code>.</p>
<p>Mapper:</p>
<pre><code>#!/usr/bin/env python

# Simple mapper, just like on the lecture slides
# Lines are split on spaces:
#  - good for word count
#  - not good for CSV or TSV files

import sys

amm_det = open('../../data/drugdb/AMM_det_H.csv', 'r')
amm = open('../../data/drugdb/AMM_H.csv', 'r')

for line in amm:
    words = line.strip().split(',')
    print '%s.%s\t%s' % (words[1], &quot;1&quot;, words[2])

for line in amm_det:
    words = line.strip().split(',')
    print '%s.%s\t%s' % (words[1], &quot;2&quot;, words[2])</code></pre>
<p>Reducer:</p>
<pre><code>#!/usr/bin/env python

# This reduces the special-format output for joining
# The first entry (.1) is the compound
# The second entry and sometimes next ones are the substances

import sys

current_cti = None
current_name = None
current_count = 0
word = None

for line in sys.stdin:
    line = line.strip()
    keys, value = line.split('\t')
    cti,d = keys.split('.')

    if int(d) == 1:
        if current_cti:
            print '%s\t%s\t%s' % (current_cti, current_count, current_value)
        current_cti = cti
        current_count = 0
        current_value = value
    if int(d) == 2:
        current_count = current_count + 1

# do not forget to output the last word if needed!
print '%s\t%s\t%s' % (current_cti, current_count, value)%</code></pre>
<p>What is the top-10?</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">hadoop</span> jar /opt/hadoop/hadoop-tools/hadoop-streaming/target/hadoop-streaming-2.4.0.jar \
  <span class="kw">-mapper</span> mapperJoin.py \
  <span class="kw">-reducer</span> reducerJoin.py \
  <span class="kw">-input</span> mapper.py \
  <span class="kw">-output</span> output</code></pre>
<p>The <code>-input</code> flag is strange and is actually a dummy file as the real input files are defined in the mapper. Be careful, this would not work as-is on HDFS!</p>
<p>To get a sorted listing:</p>
<pre><code>cat  part-00000  | sort -r -g -k2,2 -t$'\t' | head</code></pre>
<h2 id="spark">3. Spark</h2>
<p>Do the same exercise as above with the drug database, but now using the Spark interactive shell. It can be launched in the following way:</p>
<pre><code>pyspark</code></pre>
<p>Refer to the examples given in the lecture and see how far you can get.</p>
<p>Take a look at: <a href="http://spark.apache.org/docs/latest/programming-guide.html">http://spark.apache.org/docs/latest/programming-guide.html</a></p>
<p>Some examples:</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="dt">file</span> = sc.textFile(<span class="st">&quot;/mnt/bioinformatics_leuven/i0u19a/data/drugdb/AMM_det_H.csv&quot;</span>)
counts = <span class="dt">file</span>.flatMap(<span class="kw">lambda</span> line: line.split(<span class="st">&quot;,&quot;</span>)) \
             .<span class="dt">map</span>(<span class="kw">lambda</span> word: (word, <span class="dv">1</span>)) \
             .reduceByKey(<span class="kw">lambda</span> a, b: a + b)
<span class="dt">sorted</span> = counts.<span class="dt">map</span>(<span class="kw">lambda</span> x: (x[<span class="dv">1</span>],x[<span class="dv">0</span>]) ).sortByKey(<span class="ot">False</span>)</code></pre>
<p>Top-10</p>
<pre><code>sorted.take(10)</code></pre>
<p>Paracetamol:</p>
<pre><code>sorted.filter(lambda x: x[1]=='&quot;PARACETAMOL&quot;').collect()</code></pre>
<pre><code>result2 = file.map(lambda line: line.split(&quot;,&quot;)) \
    .map(lambda x: x[2]) \
    .map(lambda word: (word, 1)) \
    .reduceByKey(lambda a, b: a + b)
result2.filter(lambda x: x[0] == '&quot;PARACETAMOL&quot;').collect()</code></pre>
<p>Please remark the two types of quotes.</p>
</body>
</html>
