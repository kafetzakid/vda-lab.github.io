<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Spark for Genomic Data</title>
  <meta name="description" content="We have been researching the use of Spark and/or Shark as a backend for our visualisation projects. If you are not familiar with Spark, please take a look he...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://vda-lab.be/spark/shark/scala/2014/01/09/spark-for-genomic-data.html">
  <link rel="alternate" type="application/rss+xml" title="Visual Data Analysis Lab" href="http://vda-lab.be/feed.xml" />
</head>


  <body>
    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Visual Data Analysis Lab</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/contact.html">Contact</a>
          
        
          
        
          
          <a class="page-link" href="/index.html">Visual Data Analysis Lab</a>
          
        
          
          <a class="page-link" href="/jobs.html">Jobs</a>
          
        
          
          <a class="page-link" href="/lists.html">Lists</a>
          
        
          
        
          
          <a class="page-link" href="/people.html">People</a>
          
        
          
          <a class="page-link" href="/portfolio.html">Portfolio</a>
          
        
          
          <a class="page-link" href="/posts.html">Posts</a>
          
        
          
          <a class="page-link" href="/publications.html">Publications</a>
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Spark for Genomic Data</h1>
    <p class="post-meta">Jan 9, 2014 • Toni Verbeiren</p>
  </header>

  <article class="post-content">
    <p>We have been researching the use of <a href="http://spark.incubator.apache.org/">Spark</a> and/or <a href="https://github.com/amplab/shark/wiki">Shark</a> as a backend for our visualisation projects. If you are not familiar with Spark, please <a href="http://spark.incubator.apache.org/screencasts/1-first-steps-with-spark.html">take a look here</a>.
In short: Spark is a platform for distributed handling of data. Think of <a href="http://hadoop.apache.org/">Hadoop</a> but allowing for interactive rather than batch use. One of the first things we considered is whether to start of using Spark or rather Shark, which is based on it but offers a SQL like syntax instead of a Scala/Python/Java API. But first a word about the data and about the use of Spark to handle the data.</p>

<h1 id="data">Data</h1>

<p><a href="/assets/occurrence_transcription-factors_large.png"><img src="/assets/occurrence_transcription-factors_small.png" alt="BED file sample" /></a></p>

<p>We use a <a href="https://genome.ucsc.edu/FAQ/FAQformat.html#format1">BED</a> file as input format and took <a href="ftp://ftp.1000genomes.ebi.ac.uk/vol1/ftp/phase1/analysis_results/functional_annotation/annotation_sets/201101_encode_motifs_in_tf_peaks.bed.gz">this one</a> to start with. It contains information on <a href="http://en.wikipedia.org/wiki/Transcription_factor">transcription factors</a> and where they bind on the genome. This input format is a text file and can easily be parsed.</p>

<h2 id="parsing-the-data">Parsing the data</h2>
<p>We started by exploring the Scala interface to Spark, first from the REPL which allows for interactive exploring of the API.</p>

<p>The main benefits of using the Scala interface are the following:</p>

<ul>
  <li>No additional dependencies required</li>
  <li>All flexibility of Scala as a powerful language, byte-compatible with Java</li>
</ul>

<p>Reading in the data and parsing it can easily be done:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">bed</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="s">&quot;201101_encode_motifs_in_tf_peaks.bed&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">bedArray</span> <span class="k">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\\s+&quot;</span><span class="o">))</span></code></pre></div>

<p>This does not <em>do</em> anything yet. The method <code>collect()</code> gets the data out of the RDD structure and return an Array. The first element from the dataset can be selected using:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="o">&gt;</span><span class="n">scala</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">bedArray</span> <span class="n">take</span> <span class="mi">1</span>
<span class="o">...</span>
<span class="n">res1</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Array</span><span class="o">[</span><span class="kt">java.lang.String</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="n">chr1</span><span class="o">,</span> <span class="mi">29386</span><span class="o">,</span> <span class="mi">29397</span><span class="o">,</span> <span class="nc">Ets</span><span class="o">,</span> <span class="o">.,</span> <span class="o">-))</span></code></pre></div>

<p>Please note that by default RDDs contains <code>Array[Array[String]]</code> which makes it hard to extract the numbers and work with them. In order to convert <em>one line</em> of our data to a quadruple, we define the following function and add it as a transformation:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">extractFeatures</span><span class="o">(</span><span class="n">line</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Int</span><span class="o">,</span> <span class="nc">Int</span><span class="o">,</span> <span class="nc">String</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
  <span class="o">(</span><span class="n">line</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">toString</span><span class="o">,</span> <span class="n">line</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">toInt</span><span class="o">,</span> <span class="n">line</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="n">toInt</span><span class="o">,</span> <span class="n">line</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="n">toString</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">val</span> <span class="n">bedArray</span> <span class="k">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\\s+&quot;</span><span class="o">)).</span><span class="n">map</span><span class="o">(</span><span class="n">x</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">extractFeatures</span><span class="o">(</span><span class="n">x</span><span class="o">))</span></code></pre></div>

<p>So that we can easily filter:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">bedArray</span> <span class="n">filter</span><span class="o">(</span><span class="n">x</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">_1</span> <span class="o">==</span> <span class="s">&quot;chr4&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">.</span><span class="n">_3</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">190930000</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">.</span><span class="n">_2</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="mi">190940000</span><span class="o">))</span></code></pre></div>

<p>It would also be possible to define a class that mirrors the data and read the data into an object of that class for easier access and development.</p>

<p>A very important aspect of Spark is the possibility to cache intermediate steps in order to retrieve them faster:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">cached</span> <span class="k">=</span> <span class="n">bedArray</span><span class="o">.</span><span class="n">cache</span><span class="o">()</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">cached</span> <span class="n">filter</span><span class="o">(</span><span class="n">x</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">_1</span> <span class="o">==</span> <span class="s">&quot;chr4&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">.</span><span class="n">_3</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">190930000</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">.</span><span class="n">_2</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="mi">190940000</span><span class="o">))</span></code></pre></div>

<h1 id="discussion">Discussion</h1>

<p>The Spark framework does what it needs to do: it abstracts away everything that has to do with running code in parallel on a cluster by providing a <em>functional</em> API in Scala (as well as Python and Java).</p>

<p>In a later post, we will take a look at Shark and see how it compares to Spark and which one may be more applicable to our use-case.</p>

<h1 id="learning-resources">Learning resources</h1>
<p>Please refer to this pages for more information about Spark:</p>

<ul>
  <li><a href="http://ampcamp.berkeley.edu/big-data-mini-course/">http://ampcamp.berkeley.edu/big-data-mini-course/</a></li>
  <li><a href="http://ampcamp.berkeley.edu/amp-camp-two-strata-2013/">http://ampcamp.berkeley.edu/amp-camp-two-strata-2013/</a></li>
</ul>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Visual Data Analysis Lab</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Visual Data Analysis Lab</li>
          <li><a href="mailto:jan.aerts@kuleuven.be">jan.aerts@kuleuven.be</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
          <li>
            <a href="https://twitter.com/jandot">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">jandot</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">From data to insight – Putting the human back in the loop of data analysis
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
